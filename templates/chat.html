{% extends "base.html" %}

{% block title %}Savi - CustomGPT Chat{% endblock %}

{% block head %}
<style>
    .chat-container {
        height: calc(100vh - 120px);
        min-height: 600px;
    }
    
    /* CustomGPT Embed Styling */
    #customgpt_chat {
        height: 100%;
        min-height: 500px;
        border-radius: 8px;
        overflow: hidden;
    }
    
    /* Override CustomGPT styles to match Savi theme */
    #customgpt_chat iframe {
        border-radius: 8px !important;
        border: none !important;
    }
    
    /* Custom styling for embedded chat */
    .customgpt-container {
        background: transparent !important;
    }
    
    /* Loading animation for CustomGPT */
    .customgpt-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: white;
        opacity: 0.8;
    }
    
    .loading-beam {
        background: linear-gradient(90deg, transparent 0%, #FF6A00 50%, transparent 100%);
        animation: loading-beam 2s linear infinite;
        height: 2px;
        width: 100px;
        border-radius: 1px;
    }
    
    @keyframes loading-beam {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
</style>
{% endblock %}

{% block content %}
<div class="w-full h-full">
    
    <!-- Minimal Header -->
    <div class="text-center py-4 px-4">
        <div class="flex justify-center items-center space-x-3 mb-2">
            <img src="/static/images/Savi_logo_Savi_White out copy.png" alt="Savi" class="h-8 w-auto">
            <h1 class="text-2xl font-display font-bold text-white">
                Chat with <span class="savi-gradient bg-clip-text text-transparent">Savi</span>
            </h1>
        </div>
    </div>
    
    <!-- Full-Width CustomGPT Chat Interface -->
    <div class="w-full chat-container px-4">
        <div id="customgpt_chat" class="h-full w-full">
            <!-- Loading state -->
            <div class="customgpt-loading">
                <div class="text-center">
                    <div class="loading-beam mb-4"></div>
                    <p>Loading CustomGPT...</p>
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block scripts %}
<!-- CustomGPT Embed Script -->
<script src="https://cdn.customgpt.ai/js/embed.js" 
        defer 
        div_id="customgpt_chat" 
        p_id="{{ config.CUSTOMGPT_PROJECT_ID }}" 
        p_key="{{ config.CUSTOMGPT_PROJECT_KEY }}">
</script>

<script>
    let customGPTLoaded = false;
    
    // Initialize chat
    document.addEventListener('DOMContentLoaded', function() {
        // Monitor CustomGPT loading
        monitorCustomGPTLoad();
    });
    
    // Monitor CustomGPT loading status
    function monitorCustomGPTLoad() {
        const checkInterval = setInterval(() => {
            const chatDiv = document.getElementById('customgpt_chat');
            const iframe = chatDiv.querySelector('iframe');
            
            if (iframe) {
                customGPTLoaded = true;
                clearInterval(checkInterval);
                
                // Hide loading state
                const loadingDiv = chatDiv.querySelector('.customgpt-loading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
                
                // Show notification
                if (window.Savi && window.Savi.showNotification) {
                    window.Savi.showNotification('CustomGPT chatbot loaded successfully!', 'success');
                }
            }
        }, 1000);
        
        // Timeout after 30 seconds
        setTimeout(() => {
            if (!customGPTLoaded) {
                clearInterval(checkInterval);
                const loadingDiv = document.querySelector('.customgpt-loading p');
                if (loadingDiv) {
                    loadingDiv.textContent = 'Failed to load CustomGPT. Please refresh the page.';
                    loadingDiv.parentElement.classList.add('text-red-400');
                }
            }
        }, 30000);
    }
</script>
{% endblock %}
{% endblock %}
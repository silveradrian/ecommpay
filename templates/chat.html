{% extends "base.html" %}

{% block title %}Savi - CustomGPT Chat{% endblock %}

{% block head %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        min-height: 600px;
    }
    
    .chat-messages {
        height: 100%;
    }
    
    /* CustomGPT Embed Styling */
    #customgpt_chat {
        height: 100%;
        min-height: 500px;
        border-radius: 8px;
        overflow: hidden;
    }
    
    /* Override CustomGPT styles to match Savi theme */
    #customgpt_chat iframe {
        border-radius: 8px !important;
        border: none !important;
    }
    
    /* Custom styling for embedded chat */
    .customgpt-container {
        background: transparent !important;
    }
    
    /* Loading animation for CustomGPT */
    .customgpt-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: white;
        opacity: 0.8;
    }
    
    .loading-beam {
        background: linear-gradient(90deg, transparent 0%, #FF6A00 50%, transparent 100%);
        animation: loading-beam 2s linear infinite;
        height: 2px;
        width: 100px;
        border-radius: 1px;
    }
    
    @keyframes loading-beam {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    
    <!-- Chat Header -->
    <div class="bg-black bg-opacity-30 rounded-lg border border-white border-opacity-20 mb-6">
        <div class="p-6 text-center">
            <div class="flex justify-center mb-4">
                <div class="pulse-glow p-4 rounded-full bg-black bg-opacity-30">
                    <img src="/static/images/Savi_logo_Savi_White out copy.png" alt="Savi" class="h-12 w-auto">
                </div>
            </div>
            <h1 class="text-3xl md:text-4xl font-display font-bold text-white mb-2">
                Chat with <span class="savi-gradient bg-clip-text text-transparent">Savi</span>
            </h1>
            <p class="text-white opacity-80">Your supportive digital companion for payments</p>
        </div>
    </div>
    
    <!-- Main Chat Interface -->
    <div class="bg-black bg-opacity-30 rounded-lg border border-white border-opacity-20 chat-container">
        
        <!-- CustomGPT Chat Embed Area -->
        <div class="chat-messages p-6 h-full" id="chat-container">
            
            <!-- Welcome Message -->
            <div class="mb-4 text-center">
                <p class="text-white opacity-90 text-sm mb-4">Hey there ðŸ‘‹ I'm Savi â€” here to make payments make sense.</p>
            </div>
            
            <!-- CustomGPT Embed Container -->
            <div class="h-full bg-black bg-opacity-20 rounded-lg border border-white border-opacity-10 p-4">
                <div id="customgpt_chat" class="h-full">
                    <!-- Loading state -->
                    <div class="customgpt-loading">
                        <div class="text-center">
                            <div class="loading-beam mb-4"></div>
                            <p>Loading CustomGPT...</p>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- CustomGPT Embed Script -->
<script src="https://cdn.customgpt.ai/js/embed.js" 
        defer 
        div_id="customgpt_chat" 
        p_id="{{ config.CUSTOMGPT_PROJECT_ID }}" 
        p_key="{{ config.CUSTOMGPT_PROJECT_KEY }}">
</script>

<script>
    let customGPTLoaded = false;
    
    // Initialize chat
    document.addEventListener('DOMContentLoaded', function() {
        // Monitor CustomGPT loading
        monitorCustomGPTLoad();
    });
    
    // Monitor CustomGPT loading status
    function monitorCustomGPTLoad() {
        const checkInterval = setInterval(() => {
            const chatDiv = document.getElementById('customgpt_chat');
            const iframe = chatDiv.querySelector('iframe');
            
            if (iframe) {
                customGPTLoaded = true;
                clearInterval(checkInterval);
                
                // Hide loading state
                const loadingDiv = chatDiv.querySelector('.customgpt-loading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
                
                // Show notification
                if (window.Savi && window.Savi.showNotification) {
                    window.Savi.showNotification('CustomGPT chatbot loaded successfully!', 'success');
                }
            }
        }, 1000);
        
        // Timeout after 30 seconds
        setTimeout(() => {
            if (!customGPTLoaded) {
                clearInterval(checkInterval);
                const loadingDiv = document.querySelector('.customgpt-loading p');
                if (loadingDiv) {
                    loadingDiv.textContent = 'Failed to load CustomGPT. Please refresh the page.';
                    loadingDiv.parentElement.classList.add('text-red-400');
                }
            }
        }, 30000);
    }
</script>
{% endblock %}
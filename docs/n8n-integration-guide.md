# n8n Integration Guide

## Overview

This document provides technical specifications for integrating n8n workflows with the Knowledge Content Pipeline API.

## Base URL

**Production:** `https://ecommpay-grbzb.kinsta.app/api`

## Authentication

Currently, the API does not require authentication. All endpoints are publicly accessible.

---

## API Endpoints

### 1. List All Topics

Get all topics to find items that need processing.

```
GET /api/topics
```

**Response:**
```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "topic": "Cross-border payment regulations",
    "category": "Compliance",
    "status": "Queued",
    "created_at": "2026-02-03T10:30:00.000Z",
    "updated_at": "2026-02-03T10:30:00.000Z",
    "approved_at": null
  }
]
```

**n8n Node:** HTTP Request (GET)

---

### 2. Get Single Topic

Retrieve full details of a specific topic.

```
GET /api/topics/:id
```

**Response:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "topic": "Cross-border payment regulations",
  "category": "Compliance",
  "status": "In Progress",
  "approved_content": null,
  "md_file_path": null,
  "pdf_file_path": null,
  "created_at": "2026-02-03T10:30:00.000Z",
  "updated_at": "2026-02-03T11:00:00.000Z",
  "approved_at": null
}
```

---

### 3. Create New Topic

Create a new topic programmatically.

```
POST /api/topics
Content-Type: application/json
```

**Request Body:**
```json
{
  "topic": "AI-powered fraud detection",
  "category": "Technical"
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| topic | string | Yes | The topic title (max 500 chars) |
| category | string | No | Category label (max 100 chars) |

**Response:** Returns the created topic object with `id`.

---

### 4. Update Topic Status/Content

Update a topic's status and/or approved content. **This is the primary endpoint for n8n.**

```
PATCH /api/topics/:id
Content-Type: application/json
```

**Request Body:**
```json
{
  "status": "Approved",
  "approved_content": "# Your Generated Content\n\nMarkdown content here..."
}
```

| Field | Type | Description |
|-------|------|-------------|
| status | string | `Queued`, `In Progress`, `In Review`, `Approved`, `Rejected` |
| approved_content | string | The final approved content (markdown) |

**Important:** When status is set to `Approved`, the `approved_at` timestamp is automatically set.

---

### 5. Upload Final Output Files

Upload MD and/or PDF files generated by n8n.

```
POST /api/topics/:id/files
Content-Type: multipart/form-data
```

**Form Fields:**
| Field | Type | Description |
|-------|------|-------------|
| md | file | Markdown file (.md) |
| pdf | file | PDF file (.pdf) |

**cURL Example:**
```bash
curl -X POST https://ecommpay-grbzb.kinsta.app/api/topics/{id}/files \
  -F "md=@content.md" \
  -F "pdf=@content.pdf"
```

**Response:**
```json
{
  "message": "Files uploaded successfully",
  "topic": { /* updated topic object */ }
}
```

---

### 6. Download Files

```
GET /api/topics/:id/files/content.md
GET /api/topics/:id/files/content.pdf
```

Returns the file as a download.

---

## Status Workflow

```
Queued → In Progress → In Review → Approved
                              ↘ Rejected
```

| Status | Description |
|--------|-------------|
| `Queued` | New topic, waiting to be processed |
| `In Progress` | n8n is generating content |
| `In Review` | Content ready for human review (GoToHuman) |
| `Approved` | Content approved, visible to users |
| `Rejected` | Content rejected, needs revision |

---

## Typical n8n Workflow

1. **Trigger:** Schedule or webhook
2. **Fetch topics:** `GET /api/topics` - filter for `status: Queued`
3. **Update status:** `PATCH /api/topics/:id` with `status: In Progress`
4. **Generate content:** AI nodes (OpenAI, etc.)
5. **Update status:** `PATCH /api/topics/:id` with `status: In Review`
6. **Human approval:** GoToHuman integration
7. **Final update:** `PATCH /api/topics/:id` with `status: Approved` and `approved_content`
8. **Upload files:** `POST /api/topics/:id/files` with MD and PDF files

---

## Error Handling

All endpoints return errors in this format:

```json
{
  "error": "Error message here"
}
```

| HTTP Code | Meaning |
|-----------|---------|
| 200 | Success |
| 201 | Created (POST success) |
| 400 | Bad request (invalid data) |
| 404 | Topic not found |
| 500 | Server error |

---

## n8n HTTP Request Examples

### Fetch Queued Topics

**Node:** HTTP Request
```
Method: GET
URL: https://ecommpay-grbzb.kinsta.app/api/topics
Response Format: JSON
```

Then filter in n8n: `{{ $json.filter(item => item.status === 'Queued') }}`

### Update Topic Status

**Node:** HTTP Request
```
Method: PATCH
URL: https://ecommpay-grbzb.kinsta.app/api/topics/{{ $json.id }}
Body Content Type: JSON
Body:
{
  "status": "In Progress"
}
```

### Upload Files with Form Data

**Node:** HTTP Request
```
Method: POST
URL: https://ecommpay-grbzb.kinsta.app/api/topics/{{ $json.id }}/files
Body Content Type: Form-Data/Multipart
Body Parameters:
  - Name: md, Parameter Type: File, File From: n8n Binary Data
  - Name: pdf, Parameter Type: File, File From: n8n Binary Data
```

---

## Environment Variables

The API uses these environment variables (for reference):

| Variable | Description |
|----------|-------------|
| `DATABASE_URL` | PostgreSQL connection string |
| `DATA_DIR` | File storage path (default: `/var/lib/data`) |
| `PORT` | Server port (default: `3000`) |

---

## Health Check

Verify the API is running:

```
GET /api/health
```

**Response:**
```json
{
  "status": "ok",
  "timestamp": "2026-02-03T12:00:00.000Z"
}
```

---

## File Storage

Files are stored at: `/var/lib/data/topics/{topic-id}/`
- `content.md` - Markdown file
- `content.pdf` - PDF file

Maximum file size: 50MB per file.

---

## Contact

For issues with the API, contact the development team.